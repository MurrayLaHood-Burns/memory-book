var logger = require('logger');
var mongoose = require('mongoose');
var User = mongoose.model('User');
var messages = require('messages');

var verify = {
  owner: function(){
    return [function(req, res, next){
      if(req.user){
        req.owner = req.user;
      }
      else if(req.album){
        User.findById(req.album.createdBy, function(err, owner){
          if(err) { return next(err); }
          if(!owner) { return next( new Error('Owner not found') ); }

          req.owner = owner;
        });
      }
      else{
        return next( new Error('Not implemented'));
      }

      next();

    }, function(req, res, next){
      if(req.owner.username !== req.payload.username){
        logger.error(req.logTag, messages.error.unauthorized, {owner: req.owner.username, payload: req.payload.username});
        return res.status(401).json(messages.error.unauthorized);
      };

      next();
    }];
  }
};

module.exports = verify;
